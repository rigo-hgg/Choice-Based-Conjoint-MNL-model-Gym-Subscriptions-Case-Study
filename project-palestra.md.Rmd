---
title: 'Choice Based Conjoint MNL model: Gym Subscriptions Case Study'
output:
  html_notebook: default
  html_document:
    df_print: paged
  word_document: default
  pdf_document: default
---
Among the public places hardest hit by the lockdown to try to bring down the rate of coronavirus, there are certainly gyms, which have been closed since October and will probably be the last business to reopen. In order to understand which are the factors on which one can invest to relaunch the sector, survey participants are asked to choose one of  different subscription profiles. The various types of subscription include:
<ul>
<li> subscription duration (monthly / three-months / yearly) </li>
<li> type of activities (only fitness room / fitness room plus courses) </li>
<li>time slots in which the costumer can access the structure (7-12 / 18-23 / all day)</li>
<li>type of training schedule (standard / personalized)
- additional services (not included / access to the wellness center / physiotherapy consultancy) </li>
<li>corresponding price per month (40 euros / 60 euros / 80 euros)</li>
</ul>
The aim of the data analysis is to assess the relationship between the choice and the product attributes. To do this we  use a discrete choice model, such as the multinomial logit regression.

```{r results='hide'}
library(mlogit)
library(MASS)
library(lattice)
```
```{r results='hide'}
palestra <- read.csv("C:/Users/tamar/OneDrive/Desktop/DS-2 anno/lab of costumer/palestra.csv", sep=";")
dim(palestra) #24000 x 10
str(palestra)
```
```{r}
head(palestra)
```

Data are in long format and each respondent has to choose between 4 alternative.
```{r}
options(max.print=100)
sapply(palestra,table) #distribution of each variable 
```
We can see that each respondent has look at 80 product profiles. Each level of each attribute is properly represented and well balanced, as all levels have the same frequency. There are no respondent level variables. <br>
See some descriptive statistics:
```{r}
summary(palestra)
```
```{r}
xtabs(choice ~ abbonamento, data=palestra) #On average consumers prefer annual subscription 
```
```{r}
xtabs(choice ~ attivita, data=palestra) #On average consumers prefer fitness room plus courses instead of the only fitness room 
```
```{r}
xtabs(choice ~ orario, data=palestra)#On average consumers prefer the evening schedule
```
```{r}
xtabs(choice ~ tabella, data=palestra) #On average consumers prefer the standard training schedule 
```

```{r}
xtabs(choice ~ servizi, data=palestra) #On average consumers prefer physiotherapy consultancy as an additional service.
```
```{r}
xtabs(choice ~ prezzo, data=palestra) #On average consumers prefer the lower price (40 euros/month)
```

## MULTINOMIAL LOGIT MODEL  
Since customers have to choose between 4 alternative, we are in the context of a multilevel logit model.<br>
First of all we have to recode the variable as qualitative, also by changing the categories order of some of them in order to have a specific reference level.
```{r}
palestra$abbonamento <- factor(palestra$abbonamento, levels = c("mensile","trimestrale","annuale"))
palestra$attivita <- as.factor(palestra$attivita)
palestra$orario<-factor(palestra$orario, levels = c("allDay", "18_23","7_12"))
palestra$tabella<- factor(palestra$tabella, levels=c("standard","personalizzata" ))
palestra$servizi<-factor(palestra$servizi, levels=c("consulenza.fisioterapica",
  "centro.benessere", "non.inclusi" ))
palestra$prezzo<-as.factor(palestra$prezzo)
```
Then organize the data in long format in the properly way for the mlogit function:
```{r}
palestra_mlogit <- dfidx(palestra, idx = list(c("ques", "resp.id"), "alt"), drop.index=F,
                        levels=c("1", "2", "3", "4"))
```
Now we can fit the MNL model:
```{r}

m1 <- mlogit(choice ~ abbonamento +attivita + orario+ tabella + servizi + prezzo, data = palestra_mlogit)
summary(m1)
```
Considering that estimated coefficients are on the logit scale and tend to range mainly between -2 and 2, we can conclude that on average:
<ul>
<li>customers strongly prefer the yearly subscription compared to the monthly one, on the contrary the three-months subscription is slightly less preferred than the monthly one </li>
<li>customers prefer that in the subscription is included the possibility of attending both fitness room and the courses instead of the only fitness room </li>
<li>customers strongly prefer a cheaper subscription that allows them to enter the gym at a specific time slot than the more expensive subscription that allows them to enter at any time. The preferred time slot is 18-23 </li>
<li>customers prefer the standard training schedule </li>
<li>customers are strongly not interested having the in wellness center as an additional service, while  the physiotherapy consultancy is preferred  over having the additional services not included. </li>
<li>customers prefers the lower price </li>
</ul>
 
Concerning the alternative specific constants, they are are not significant and indeed here we are not expected a respondent chooses a subscription option because it is positioned
in a certain way. We can check if this intuition is correct by fitting a nested smaller model without intercept parameters and then by comparing it
with the the larger model with intercepts through a likelihood ratio test.
```{r}
m2 <- mlogit(choice ~ abbonamento +attivita + orario+ tabella + servizi + prezzo| -1, data = palestra_mlogit)
lrtest(m2,m1) #comparison between models 
```

The comparison leads to a large p-value of 0.498. Therefore we can conclude that the two models are not significantly different in terms of goodness of fit and they explain the data equally well. As consequences, alternative specific constants are not necessary to adequately model the data.

### Compute the willingness-to-pay
The likelihood ratio test can be also useful to decide if the price variable must be included as quantitative predictor instead of being qualitative. Therefore we now fit the model without intercept parameters and with <i>prezzo</i> as a quantitative variable in order to compare it with the restricted model with <i>prezzo</i> as qualitative.
```{r}
m3 <- mlogit(choice ~ abbonamento +attivita + orario+ tabella + servizi 
                      + as.numeric(as.character(prezzo)) | -1, data = palestra_mlogit)
lrtest(m3, m2) #comparison between models 
```
This comparison leads instead to a p value of 0.001. It means that this new specification  significantly reduce the goodness of fit and it is better to keep price variable as qualitative. <br>
Nevertheless 0.001 may be considered a borderline result in terms of statistical significance and choosing the highest significance level, we might consider the model with quantitative price variable and  try  to compute the willingness-to-pay, since interpreting the measures of part-worths is quite difficult.For example for the personalized schedule level we can compute the following quantity expressed in euros: 
```{r}
coef(m3)["tabellapersonalizzata"]/(coef(m3)["as.numeric(as.character(prezzo))"])
```
The interpretation is that 26 euros is the price at which customers tend to become indifferent between the two schedule options (standard or personalized).

### Simulate Preference Shares  
Together with willingness-to-pay measures, another useful approach to assess the role of subscription attributes consists on using the model to obtain preference share predictions. <br>
First of all we have to define the "predict.mnl" function.
```{r}
predict.mnl <- function(model, data) {
 
  data.model <- model.matrix(update(model$formula, 0 ~ .), data = data)[,-1]
  logitUtility <- data.model%*%model$coef
  share <- exp(logitUtility)/sum(exp(logitUtility))
  cbind(share, data)
}
```
In order to use "predict.mnl" we have to define a data frame containing the set of designs for which we want to predict the preference shares. To do that, we first
create the full set of possible designs:
```{r results='hide'}
attributes <- list(
abbonamento=names(table(palestra_mlogit$abbonamento)),
attivita=names(table(palestra_mlogit$attivita)),
orario=names(table(palestra_mlogit$orario)),
tabella=names(table(palestra_mlogit$tabella)),
servizi=names(table(palestra_mlogit$servizi)),
prezzo=names(table(palestra_mlogit$prezzo))
)
allDesign <- expand.grid(attributes) 
options(max.print=350)
allDesign
```
And then we choose a reasonable subset where the first row indicates our planned design and the others rows indicate realistic designs offered by competitors:

```{r}
new_data <- allDesign[c(12, 85, 274,140,185,132), ]
new_data
```
Now we can predict the preference shares:
```{r}
predict.mnl(m2, new_data)
```
We expect consumers to choose our product design basically 89% of times. <br>
It useful to get not only the point estimates but also the bootstrap confidence intervals for the preference shares. Indeed predictions are not reliable if the level of accertainty is not declared.
```{r echo=TRUE}
source("BootCI.predict.mnl.R") #load the function
library(parallel)
BootCI.predict.mnl(m2  , new_data, nsim = 500, conflevel = 0.95) #use the default values

```

### Sensitivity chart 
It can be useful to plot the expected changes in preference shares by plotting the sensitivity chart for our planned subscription design with: yearly duration, fitness room plus courses, 18-23 time slot,standard training schedule, physiotherapy consultancy included for a prince of 40/month.
```{r}
sensitivity.mnl <- function(model, attrib, base.data, competitor.data) {

  data <- rbind(base.data, competitor.data)
  base.share <- predict.mnl(model, data)[1,1]
  share <- NULL
  for (a in seq_along(attrib)) {
    for (i in attrib[[a]]) {
      data[1,] <- base.data
      data[1,a] <- i
      share <- c(share, predict.mnl(model, data)[1,1])
    }
  }
  data.frame(level=unlist(attrib), share=share, increase=share-base.share)
}
```

```{r results='hide'}
base.data <- new_data[1,]
competitor.data <- new_data[-1,]
(tradeoff <- sensitivity.mnl(m2, attributes, base.data, competitor.data)) #importance of the attributes (preference share)
tradeoff$level
```

```{r}
barplot(tradeoff$increase, horiz=F, names.arg=c("1M","3M", "12M","Room", "Room + courses","allDay","18-23","7-12", "standard", "personalized", "Physio","Wellness","NA Services", "40euros", "60euros", "80euros"),
        las=2 ,
        col="#69b3a2",
        ylab="Change in Share for the Planned Subscription Design", 
        
        ylim=c(-0.5,0.1))
grid(nx=NA, ny=NULL) 
```
We can see that each change in the attribute levels of the planned design leads to a preference share decrease. In particular the worst changes would be: 
<ul>
<li>In the time slot attribute: from 18-23 level to All Day level.In this case the preference share decreases by almost 0.5 </li>
<li>In the additional services attribute: from physiotherapy consultancy to access to wellness center. In this case the preference share decreases by  0.3 </li>
<li> In the duration attribute: from yearly duration level to 3-months level. In this case the preference share decreases by almost 0.3 </li>
</ul>

## MIXED MULTINOMIAL LOGIT  MODEL
We want now to perform a mixed multinomial logit model in order to deal with consumer heterogeneity. <br>
To estimate it  using "mlogit", we have to define a vector called "m2.rpar" indicating which coefficients should vary across customers. The vector must have the same length as the coefficient vector with a letter code indicating what distribution the random coefficients follow across the respondents, for example N for normal. Tipically, we assume that all the coefficients are normally distributed across the population.
```{r}
rpar <- rep("n", length=length(m2$coef))
names(rpar) <- names(m2$coef)
```
We pass this vector to mlogit as the rpar parameter, which stands for random  parameters. In addition, we tell mlogit that we have multiple choice observations for each respondent (panel=TRUE) and that we do not want to allow the random parameters to be correlated with each other (correlation=FALSE)
```{r}
m2_mixed <- mlogit(choice ~ abbonamento +attivita + orario+ tabella + servizi + prezzo| -1, data = palestra_mlogit, 
                  panel=TRUE, rpar = rpar, correlation = FALSE) 

```

```{r}
summary(m2_mixed)
```
For each level attribute we estimate now two parameters instead of one: the estimated average coefficients  and the estimated standard deviations, indicating the variability of coefficients across respondents. In general the higher the standard deviation the higher the heterogeneity. In particular we may have to consider the heterogeneity in the preference for:
<ul>
<li> the yearly subscription over the three-months
 one: while consumers on average prefer the annual subscription, there is a non-negligible fraction of them which prefer the three-month one </li>  
<li> the physiotherapy consultancy as an additional service over having  additional services not included </li>
<li>the lower price over the one of 60 euro   </li>
</ul>
The random effects do not show sign reversals in the quartiles distribution but we can check the visual summary of the distribution of the random effects and hence of the level of heterogeneity:
```{r}
plot(m2_mixed)
```
As the plot shows, there is a narrow market  niche of customers who has a stronger preference for the three-months subscription with respect to average customers preference and there is also a narrow niche who has a stronger preference for having the additional services not included with respect to other customers. 


### Mixed MLN Model with correlated random effects 
The model above has covariances among random effects equal to zero, but with correlated random effect coefficients one can asses whether consumers who favor one attribute level also tend to favor another attribute level. So now we use the update function
 provided by mlogit to estimate the mixed MNL model with correlated random effects:
```{r}
m2_mixed2 <- update(m2_mixed, correlation = TRUE)
```
We can test the hypothesis that the random parameters are uncorrelated:
```{r}
waldtest(m2_mixed2, correlation = FALSE)
```
The test clearly reject the hypothesis that the random parameters are uncorrelated. <br>
To get a better sense of the strength of the association among random coefficients, we extract the covariance matrix:
```{r message=FALSE}
as.data.frame(cov2cor(cov.mlogit(m2_mixed2)))

```
The covariance matrix shows strong associations between the part worth for the following attributes and levels:
<ul>
<li>a negative association between yearly subscriptions and the three-months one </li>
<li>a positive association between 18-23 time slot and 7-12 time slot </li>
<li>a positive association between wellness center and additional service non included </li>
</ul>.
We obtain the standard errors of the correlations among random effects and hence perform significance test in order to see which correlations are significant:
```{r fig.height=5, fig.width=7}
summary(vcov(m2_mixed2, what = "rpar", type = "cor"))
```
That confirms the correlations mentioned above. In particular  the correlation between orario18_23:orario7_12 and between servizicentro.benessere:servizinon.inclusi are highly significant, showing that respondents have behaved rationally. Indeed it has perfectly sense that a consumer always prefers to go to the gym at a certain time rather than all day. <br>
We can reduce the model complexity by only including the highest significant correlations
```{r}
m2_mixed3 <- update(m2_mixed2, correlation = c("orario18_23", "orario7_12", "servizicentro.benessere","servizinon.inclusi" ))

```
 The significant presence of random coefficients and their correlation can be further investigated using  the ML ratio test:
```{r}
lrtest(m2, m2_mixed) #Fixed effects vs. uncorrelated random effects
```
 We can reject the null hypothesis that the variances of the random effects are jointly equal to zero. Therefore we should use the model with random effects.
```{r}
lrtest(m2_mixed, m2_mixed2) #Uncorrelated random effects vs. all correlated random effects
```
Moreover we can not assume that random effects are independent, the model with correlated random effects has a better goodness of fit.
 
```{r}
lrtest(m2_mixed3, m2_mixed2) #partially correlated random effects vs. all correlated random effects
```
And at the end our best model is the  one that includes all random effects. Once we have established it, we can compute the preference shares.
 

### Simulating shares
To compute share predictions with a mixed MNL model,
we have to compute the preference shares for each of newly sampled, representative respondents. The part worths for these respondents are drawn from a multivariate normal distribution. Once we have the preference shares for all of the representative respondents, we average across respondents to get our overall preference share predictions. <br>
Firstly we have to implement the function for predicting shares from a mixed MNL model 
```{r}
predict.mixed.mnl <- function(model, data, nresp=1000){
  data.model <- model.matrix(update(model$formula, 0 ~ .), data = data)[,-1]
  coef.Sigma <- cov.mlogit(model)
  coef.mu <- model$coef[1:dim(coef.Sigma)[1]]
  draws <- mvrnorm(n=nresp, coef.mu, coef.Sigma)
  shares <- matrix(NA, nrow=nresp, ncol=nrow(data))
  for (i in 1:nresp) {
    utility <- data.model%*%draws[i,]
    share = exp(utility)/sum(exp(utility))
    shares[i,] <- share
  }
  cbind(colMeans(shares), data)
}
```
Now we can compute the preference shares:
```{r}
set.seed(123)
predict.mixed.mnl(m2_mixed2, data=new_data)
```
As we can see, preference shares of the random effects model are slightly different with respect to those seen in the fixed effects model. That happens since the mixed model better account for the costumer heterogeneity, by predicting larger preference shares to niche product. <br>
For the sake of completeness we point out that also in this case it is possible to calculate the confidence intervals of the preference shares, even if we do not implement the code due to its high complexity
```{r results='hide'}
source("BootCI.predict.mixed.mnl.R") #load the function
library(parallel)
BootCI.predict.mixed.mnl(m2_mixed2, new_data, nsim = 500, conflevel = 0.95,nresp=1000) #use the default values
```

 
## Conclusions 
We have found out that our best model is the mixed multinomial logit model that includes all random effects. According to consumers preferences, gym subscriptions  should have these characteristics: of yearly duration, 	including fitness room plus courses,	allowing the access in the 18-23 time slot, including the standard training schedule , including a physiotherapy consultancy as an additional service, price of	40 euros/month. Thank to this kind of model, we also have been able to control for the circumstance that there are small fractions of respondents for which "niche products", such as three-months subscription and additional services not included, have great value.








